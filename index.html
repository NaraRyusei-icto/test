<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crew Nest — デモモック</title>
<style>
/* ===== CSS 変数 ===== */
:root {
  --color-primary: #042154;
  --color-accent: #C6A75E;
  --color-subtle: #5C6B8A;
  --color-background: #F7F8FA;
  --color-border: #E3E6ED;
  --color-text: #333333;
  --color-bg-light: #FFFFFF;
  --color-subtle-light: #8A99B8;

  /* カテゴリカラー */
  --cat-blue-border: #5B7FC0;
  --cat-blue-bg: #EEF2F8;
  --cat-blue-text: #3D5A99;
  --cat-amber-border: #B89B52;
  --cat-amber-bg: #F5F1E8;
  --cat-amber-text: #8A7340;
  --cat-green-border: #5A9E74;
  --cat-green-bg: #EDF5F0;
  --cat-green-text: #3D7A56;
  --cat-rose-border: #C07B8A;
  --cat-rose-bg: #F5EDEF;
  --cat-rose-text: #995C6B;

  /* ステータスカラー */
  --st-pending-bg: #F5F1E8;
  --st-pending-text: #8A7340;
  --st-pending-border: #E5D9C0;
  --st-approved-bg: #EDF5F0;
  --st-approved-text: #3D7A56;
  --st-approved-border: #C5DFD0;
  --st-rejected-bg: #F5EDEF;
  --st-rejected-text: #995C6B;
  --st-rejected-border: #E5CDD3;
  --st-returned-bg: #F0F1F4;
  --st-returned-text: #5C6B8A;
  --st-returned-border: #D5D9E3;
  --st-withdrawn-bg: #F3F4F6;
  --st-withdrawn-text: #8A8F9C;
  --st-withdrawn-border: #E0E2E8;

  --sidebar-w: 280px;
  --sidebar-collapsed-w: 72px;
  --bottom-nav-h: 64px;
}

/* ===== リセット & ベース ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
  background: var(--color-background);
  color: var(--color-text);
  font-size: 14px;
  line-height: 1.5;
}
button { cursor: pointer; font-family: inherit; font-size: inherit; }
input, textarea { font-family: inherit; font-size: inherit; }
a { text-decoration: none; color: inherit; }

/* ===== スクリーン切り替え ===== */
.screen { display: none; width: 100%; height: 100%; }
.screen.active { display: flex; }

/* ===== ログイン画面 ===== */
#screen-login {
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--color-primary) 0%, #0a3a7a 100%);
  min-height: 100vh;
}
.login-card {
  background: var(--color-bg-light);
  border-radius: 20px;
  padding: 48px 40px;
  width: min(420px, 90vw);
  text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.login-logo {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 32px;
}
.login-logo-icon {
  width: 48px;
  height: 48px;
  background: var(--color-primary);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.login-logo-text {
  font-size: 24px;
  font-weight: 700;
  color: var(--color-primary);
}
.login-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--color-primary);
  margin-bottom: 8px;
}
.login-subtitle {
  font-size: 14px;
  color: var(--color-subtle);
  margin-bottom: 40px;
  line-height: 1.6;
}
.btn-ms-login {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  width: 100%;
  padding: 14px 20px;
  background: var(--color-primary);
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  transition: background 0.2s, transform 0.1s;
}
.btn-ms-login:hover { background: #063070; transform: translateY(-1px); }
.btn-ms-login:active { transform: translateY(0); }

/* ===== アプリシェル（ログイン後） ===== */
#screen-app {
  flex-direction: row;
  height: 100vh;
  overflow: hidden;
}

/* ===== サイドバー ===== */
.sidebar {
  width: var(--sidebar-w);
  min-width: var(--sidebar-w);
  height: 100vh;
  background: var(--color-primary);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: width 0.3s ease, min-width 0.3s ease;
  flex-shrink: 0;
  position: relative;
  z-index: 10;
}
.sidebar.collapsed {
  width: var(--sidebar-collapsed-w);
  min-width: var(--sidebar-collapsed-w);
}

/* サイドバーヘッダー */
.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 14px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  min-height: 60px;
  flex-shrink: 0;
}
.sidebar-brand {
  display: flex;
  align-items: center;
  gap: 10px;
  overflow: hidden;
}
.sidebar-brand-icon {
  width: 36px;
  height: 36px;
  background: var(--color-accent);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.sidebar-brand-name {
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  transition: opacity 0.2s;
}
.sidebar.collapsed .sidebar-brand-name { opacity: 0; width: 0; }
.sidebar-toggle {
  background: none;
  border: none;
  color: rgba(255,255,255,0.7);
  padding: 6px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: color 0.2s, background 0.2s;
}
.sidebar-toggle:hover { color: #fff; background: rgba(255,255,255,0.1); }

/* サイドバーナビ */
.sidebar-nav {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 12px 8px;
  scrollbar-width: none;
}
.sidebar-nav::-webkit-scrollbar { display: none; }

.nav-section-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.08em;
  color: rgba(255,255,255,0.4);
  padding: 12px 8px 4px;
  white-space: nowrap;
  overflow: hidden;
  transition: opacity 0.2s;
}
.sidebar.collapsed .nav-section-label { opacity: 0; }

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 10px;
  border-radius: 8px;
  color: rgba(255,255,255,0.7);
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
  white-space: nowrap;
  overflow: hidden;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  font-size: 14px;
}
.nav-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
.nav-item.active { background: rgba(255,255,255,0.15); color: #fff; }

.nav-item-icon {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}
.nav-item-label {
  flex: 1;
  transition: opacity 0.2s;
}
.sidebar.collapsed .nav-item-label { opacity: 0; width: 0; }

.nav-badge {
  background: var(--color-accent);
  color: var(--color-primary);
  font-size: 10px;
  font-weight: 700;
  padding: 1px 6px;
  border-radius: 9999px;
  min-width: 18px;
  text-align: center;
  transition: opacity 0.2s;
}
.sidebar.collapsed .nav-badge { opacity: 0; }

.nav-sub-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 10px 7px 36px;
  border-radius: 8px;
  color: rgba(255,255,255,0.55);
  cursor: pointer;
  font-size: 13px;
  transition: background 0.15s, color 0.15s;
  white-space: nowrap;
  overflow: hidden;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
}
.sidebar.collapsed .nav-sub-item { padding-left: 10px; }
.nav-sub-item:hover { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.9); }
.nav-sub-item.active { background: rgba(255,255,255,0.1); color: #fff; }
.sidebar.collapsed .nav-sub-item-label { opacity: 0; width: 0; display: none; }

/* サイドバーユーザー */
.sidebar-user {
  padding: 12px 10px;
  border-top: 1px solid rgba(255,255,255,0.1);
  display: flex;
  align-items: center;
  gap: 10px;
  overflow: hidden;
  flex-shrink: 0;
}
.sidebar-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--color-accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
  color: var(--color-primary);
  flex-shrink: 0;
}
.sidebar-user-info {
  overflow: hidden;
  transition: opacity 0.2s;
}
.sidebar.collapsed .sidebar-user-info { opacity: 0; width: 0; }
.sidebar-user-name { font-size: 13px; font-weight: 600; color: #fff; white-space: nowrap; }
.sidebar-user-email { font-size: 11px; color: rgba(255,255,255,0.5); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }

/* ===== メインコンテンツ ===== */
.main-content {
  flex: 1;
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

/* トップバー */
.topbar {
  height: 52px;
  background: var(--color-bg-light);
  border-bottom: 1px solid var(--color-border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  flex-shrink: 0;
}
.topbar-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--color-primary);
}
.topbar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}
.notif-btn {
  position: relative;
  background: none;
  border: none;
  padding: 6px;
  border-radius: 8px;
  color: var(--color-subtle);
  display: flex;
  align-items: center;
  transition: background 0.15s;
}
.notif-btn:hover { background: var(--color-background); }
.notif-badge {
  position: absolute;
  top: 2px;
  right: 2px;
  background: #ef4444;
  color: #fff;
  font-size: 9px;
  font-weight: 700;
  min-width: 16px;
  height: 16px;
  border-radius: 9999px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 3px;
}
.topbar-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--color-accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
  color: var(--color-primary);
  cursor: pointer;
}

/* ページエリア */
.page-area {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  position: relative;
}
.page { display: none; padding: 24px; height: 100%; }
.page.active { display: block; }

/* ===== BottomNav（モバイル） ===== */
.bottom-nav {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: var(--bottom-nav-h);
  background: var(--color-bg-light);
  border-top: 1px solid var(--color-border);
  z-index: 50;
}
.bottom-nav-inner {
  display: flex;
  height: 100%;
  align-items: center;
}
.bottom-nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  padding: 8px 4px;
  color: var(--color-subtle-light);
  cursor: pointer;
  background: none;
  border: none;
  transition: color 0.15s;
  position: relative;
}
.bottom-nav-item.active { color: var(--color-primary); }
.bottom-nav-item svg { flex-shrink: 0; }
.bottom-nav-label { font-size: 10px; font-weight: 500; }
.bottom-nav-badge {
  position: absolute;
  top: 6px;
  right: calc(50% - 18px);
  background: #ef4444;
  color: #fff;
  font-size: 9px;
  font-weight: 700;
  min-width: 15px;
  height: 15px;
  border-radius: 9999px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 3px;
}

/* ===== ページ: ホーム ===== */
.home-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  max-width: 900px;
}
@media (max-width: 640px) {
  .home-grid { grid-template-columns: 1fr; }
}

.home-card {
  background: var(--color-bg-light);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.07);
}
.home-card-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--color-subtle);
  margin-bottom: 16px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.user-card {
  grid-column: 1 / -1;
  background: var(--color-primary);
  color: #fff;
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}
.user-card-avatar {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--color-accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  font-weight: 700;
  color: var(--color-primary);
  flex-shrink: 0;
}
.user-card-info { flex: 1; }
.user-card-name { font-size: 18px; font-weight: 700; margin-bottom: 2px; }
.user-card-email { font-size: 13px; color: rgba(255,255,255,0.6); }
.user-card-pts {
  text-align: right;
}
.user-card-pts-label { font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 2px; }
.user-card-pts-val { font-size: 28px; font-weight: 700; color: var(--color-accent); }

.stat-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
.stat-item { text-align: center; }
.stat-val { font-size: 24px; font-weight: 700; color: var(--color-primary); }
.stat-label { font-size: 12px; color: var(--color-subtle); margin-top: 2px; }

.notif-widget-list { display: flex; flex-direction: column; gap: 8px; }
.notif-widget-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 10px;
  background: var(--color-background);
  cursor: pointer;
  transition: background 0.15s;
  border: none;
  text-align: left;
  width: 100%;
}
.notif-widget-item:hover { background: var(--color-border); }
.notif-widget-item.unread { background: #EEF2F8; }
.notif-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--color-accent);
  margin-top: 4px;
  flex-shrink: 0;
}
.notif-dot.read { background: var(--color-border); }
.notif-widget-text { font-size: 13px; color: var(--color-text); line-height: 1.4; }
.notif-widget-time { font-size: 11px; color: var(--color-subtle-light); margin-top: 2px; }

/* ===== ページ: クエスト一覧 ===== */
.quest-toolbar {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.search-input {
  flex: 1;
  min-width: 180px;
  padding: 9px 14px;
  border: 1px solid var(--color-border);
  border-radius: 10px;
  background: var(--color-bg-light);
  color: var(--color-text);
  outline: none;
  font-size: 14px;
  transition: border-color 0.15s;
}
.search-input:focus { border-color: var(--color-subtle); }
.search-input::placeholder { color: var(--color-subtle-light); }

.filter-group {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.filter-btn {
  padding: 7px 14px;
  border-radius: 9999px;
  font-size: 13px;
  font-weight: 500;
  border: 1px solid var(--color-border);
  background: var(--color-bg-light);
  color: var(--color-subtle);
  transition: all 0.15s;
}
.filter-btn:hover { border-color: var(--color-subtle); color: var(--color-text); }
.filter-btn.active-blue { background: var(--cat-blue-bg); color: var(--cat-blue-text); border-color: var(--cat-blue-border); }
.filter-btn.active-amber { background: var(--cat-amber-bg); color: var(--cat-amber-text); border-color: var(--cat-amber-border); }
.filter-btn.active-green { background: var(--cat-green-bg); color: var(--cat-green-text); border-color: var(--cat-green-border); }
.filter-btn.active-rose { background: var(--cat-rose-bg); color: var(--cat-rose-text); border-color: var(--cat-rose-border); }

.quest-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 14px;
}
@media (max-width: 600px) {
  .quest-grid { grid-template-columns: 1fr; }
}

/* クエストカード */
.quest-card {
  background: var(--color-bg-light);
  border-radius: 14px;
  border-left: 4px solid var(--color-border);
  box-shadow: 0 1px 3px rgba(0,0,0,0.07);
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  overflow: hidden;
}
.quest-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.quest-card.blue  { border-left-color: var(--cat-blue-border); }
.quest-card.amber { border-left-color: var(--cat-amber-border); }
.quest-card.green { border-left-color: var(--cat-green-border); }
.quest-card.rose  { border-left-color: var(--cat-rose-border); }

.quest-card-inner { padding: 14px 16px; }
.quest-card-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 8px;
  margin-bottom: 10px;
}
.quest-card-badges { display: flex; flex-wrap: wrap; gap: 5px; }
.cat-badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 9999px;
  font-size: 10px;
  font-weight: 600;
  border: 1px solid;
}
.cat-badge.blue  { background: var(--cat-blue-bg);  color: var(--cat-blue-text);  border-color: var(--cat-blue-border); }
.cat-badge.amber { background: var(--cat-amber-bg); color: var(--cat-amber-text); border-color: var(--cat-amber-border); }
.cat-badge.green { background: var(--cat-green-bg); color: var(--cat-green-text); border-color: var(--cat-green-border); }
.cat-badge.rose  { background: var(--cat-rose-bg);  color: var(--cat-rose-text);  border-color: var(--cat-rose-border); }

.freq-badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 9999px;
  font-size: 10px;
  font-weight: 500;
  background: var(--color-background);
  color: var(--color-subtle);
  border: 1px solid var(--color-border);
}
.quest-card-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--color-text);
  margin-bottom: 10px;
  line-height: 1.4;
}
.quest-card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 8px;
}
.quest-pts {
  display: flex;
  align-items: baseline;
  gap: 3px;
}
.quest-pts-val { font-size: 18px; font-weight: 700; color: var(--color-primary); }
.quest-pts-unit { font-size: 11px; color: var(--color-subtle); }

.quest-status-badge {
  display: inline-flex;
  align-items: center;
  padding: 3px 9px;
  border-radius: 9999px;
  font-size: 11px;
  font-weight: 600;
  border: 1px solid;
}
.quest-status-badge.approved { background: var(--st-approved-bg); color: var(--st-approved-text); border-color: var(--st-approved-border); }
.quest-status-badge.pending  { background: var(--st-pending-bg);  color: var(--st-pending-text);  border-color: var(--st-pending-border); }

/* リングゲージ */
.ring-gauge { flex-shrink: 0; }

/* ===== 右スライドパネル共通 ===== */
.panel-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  z-index: 40;
  backdrop-filter: blur(2px);
}
.panel-overlay.open { display: block; }

.slide-panel {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  width: min(480px, 100vw);
  background: var(--color-bg-light);
  box-shadow: -4px 0 24px rgba(0,0,0,0.15);
  z-index: 41;
  display: flex;
  flex-direction: column;
  transform: translateX(100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
}
.slide-panel.open { transform: translateX(0); }

.panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--color-border);
  flex-shrink: 0;
  background: var(--color-bg-light);
}
.panel-title { font-size: 16px; font-weight: 700; color: var(--color-primary); }
.panel-close {
  background: none;
  border: none;
  padding: 6px;
  border-radius: 8px;
  color: var(--color-subtle);
  display: flex;
  align-items: center;
  transition: background 0.15s;
}
.panel-close:hover { background: var(--color-background); color: var(--color-text); }

.panel-body {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}
.panel-body::-webkit-scrollbar { width: 4px; }
.panel-body::-webkit-scrollbar-track { background: transparent; }
.panel-body::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 9999px; }

.panel-footer {
  padding: 16px 20px;
  border-top: 1px solid var(--color-border);
  flex-shrink: 0;
  background: var(--color-bg-light);
}

/* ===== クエスト詳細パネル ===== */
.quest-detail-section { margin-bottom: 20px; }
.quest-detail-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--color-subtle);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 6px;
}
.quest-detail-value { font-size: 14px; color: var(--color-text); line-height: 1.6; }

.detail-pts {
  display: flex;
  align-items: baseline;
  gap: 4px;
}
.detail-pts-val { font-size: 28px; font-weight: 700; color: var(--color-primary); }
.detail-pts-unit { font-size: 13px; color: var(--color-subtle); }

.form-group { margin-bottom: 16px; }
.form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--color-subtle);
  margin-bottom: 6px;
}
.form-input, .form-textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--color-border);
  border-radius: 8px;
  background: var(--color-background);
  color: var(--color-text);
  outline: none;
  font-size: 14px;
  transition: border-color 0.15s;
}
.form-input:focus, .form-textarea:focus { border-color: var(--color-subtle); background: var(--color-bg-light); }
.form-textarea { resize: vertical; min-height: 80px; }

.upload-area {
  border: 2px dashed var(--color-border);
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  color: var(--color-subtle-light);
  font-size: 13px;
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s;
}
.upload-area:hover { border-color: var(--color-subtle); background: var(--color-background); }

/* ===== ボタン ===== */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 18px;
  border-radius: 9px;
  font-size: 14px;
  font-weight: 600;
  border: 1px solid transparent;
  transition: all 0.15s;
  cursor: pointer;
}
.btn-primary { background: var(--color-primary); color: #fff; }
.btn-primary:hover { background: #063070; }
.btn-accent { background: var(--color-accent); color: var(--color-primary); }
.btn-accent:hover { background: #b8963a; }
.btn-outline { background: transparent; border-color: var(--color-border); color: var(--color-text); }
.btn-outline:hover { border-color: var(--color-subtle); background: var(--color-background); }
.btn-danger { background: #fff0f0; color: #dc2626; border-color: #fca5a5; }
.btn-danger:hover { background: #fee2e2; }
.btn-warn { background: #fff7ed; color: #c2410c; border-color: #fdba74; }
.btn-warn:hover { background: #ffedd5; }
.btn-sm { padding: 6px 12px; font-size: 12px; }
.btn-block { width: 100%; }

/* ===== ページ: 申告管理 ===== */
.page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 8px;
}
.page-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--color-primary);
}
.tabs {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  padding-bottom: 2px;
  margin-bottom: 16px;
  scrollbar-width: none;
}
.tabs::-webkit-scrollbar { display: none; }
.tab {
  flex-shrink: 0;
  padding: 7px 16px;
  border-radius: 9999px;
  font-size: 13px;
  font-weight: 500;
  border: 1px solid var(--color-border);
  background: var(--color-bg-light);
  color: var(--color-subtle);
  transition: all 0.15s;
}
.tab:hover { border-color: var(--color-subtle); }
.tab.active { background: var(--color-primary); color: #fff; border-color: var(--color-primary); }

.achievement-list { display: flex; flex-direction: column; gap: 10px; }
.achievement-card {
  background: var(--color-bg-light);
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  cursor: pointer;
  transition: box-shadow 0.15s;
  border: 2px solid transparent;
}
.achievement-card:hover { box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
.achievement-card.selected { border-color: var(--color-primary); }
.achievement-card-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 8px;
  margin-bottom: 8px;
}
.achievement-card-title { font-weight: 600; font-size: 14px; color: var(--color-text); }
.achievement-card-meta {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 12px;
  color: var(--color-subtle);
  flex-wrap: wrap;
}

/* ステータスバッジ */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 9px;
  border-radius: 9999px;
  font-size: 11px;
  font-weight: 600;
  border: 1px solid;
  white-space: nowrap;
}
.status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
.status-PENDING   { background: var(--st-pending-bg);   color: var(--st-pending-text);   border-color: var(--st-pending-border); }
.status-APPROVED  { background: var(--st-approved-bg);  color: var(--st-approved-text);  border-color: var(--st-approved-border); }
.status-REJECTED  { background: var(--st-rejected-bg);  color: var(--st-rejected-text);  border-color: var(--st-rejected-border); }
.status-RETURNED  { background: var(--st-returned-bg);  color: var(--st-returned-text);  border-color: var(--st-returned-border); }
.status-WITHDRAWN { background: var(--st-withdrawn-bg); color: var(--st-withdrawn-text); border-color: var(--st-withdrawn-border); }
.status-APPROVAL  { background: var(--st-pending-bg);   color: var(--st-pending-text);   border-color: var(--st-pending-border); }

.status-dot-PENDING   { background: var(--st-pending-text); }
.status-dot-APPROVED  { background: var(--st-approved-text); }
.status-dot-REJECTED  { background: var(--st-rejected-text); }
.status-dot-RETURNED  { background: var(--st-returned-text); }
.status-dot-WITHDRAWN { background: var(--st-withdrawn-text); }
.status-dot-APPROVAL  { background: var(--st-pending-text); }

/* 申告詳細パネル */
.detail-section {
  margin-bottom: 20px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--color-border);
}
.detail-section:last-child { border-bottom: none; }
.detail-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--color-subtle);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 6px;
}
.detail-text { font-size: 14px; color: var(--color-text); line-height: 1.6; }
.detail-comment-box {
  background: var(--color-background);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  padding: 12px;
  font-size: 13px;
  color: var(--color-text);
  line-height: 1.6;
}
.detail-comment-box.approver {
  background: #EEF2F8;
  border-color: var(--cat-blue-border);
}

.approval-actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* ===== ページ: 通知 ===== */
.notif-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 8px;
}
.notif-list { display: flex; flex-direction: column; gap: 8px; }
.notif-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 16px;
  background: var(--color-bg-light);
  border-radius: 12px;
  cursor: pointer;
  border: 1px solid transparent;
  transition: all 0.15s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.notif-item:hover { box-shadow: 0 3px 10px rgba(0,0,0,0.08); border-color: var(--color-border); }
.notif-item.unread { background: #EEF2F8; border-color: var(--cat-blue-bg); }
.notif-item.unread:hover { border-color: var(--cat-blue-border); }

.notif-icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.notif-icon.approved { background: var(--st-approved-bg); }
.notif-icon.returned { background: var(--st-returned-bg); }
.notif-icon.pending  { background: var(--st-pending-bg); }

.notif-content { flex: 1; }
.notif-title { font-size: 14px; font-weight: 600; color: var(--color-text); margin-bottom: 3px; line-height: 1.4; }
.notif-item.unread .notif-title { color: var(--color-primary); }
.notif-time { font-size: 12px; color: var(--color-subtle-light); }
.notif-unread-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--color-accent);
  margin-top: 6px;
  flex-shrink: 0;
}

/* ===== 空状態 ===== */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  color: var(--color-subtle-light);
  gap: 12px;
}
.empty-state-icon { opacity: 0.4; }
.empty-state-text { font-size: 14px; }

/* ===== モバイル対応 ===== */
@media (max-width: 767px) {
  .sidebar { display: none; }
  .bottom-nav { display: flex; }
  .page { padding: 16px 16px calc(var(--bottom-nav-h) + 16px); }
  .home-grid { gap: 12px; }
  .slide-panel { width: 100vw; }
  .topbar { display: none; }
}

/* ===== ページタイトルバー（モバイル） ===== */
.mobile-header {
  display: none;
}
@media (max-width: 767px) {
  .mobile-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--color-primary);
    color: #fff;
    flex-shrink: 0;
  }
  .mobile-header-title { font-size: 16px; font-weight: 700; }
  .mobile-header-right { display: flex; align-items: center; gap: 8px; }
}

/* ===== ユーティリティ ===== */
.text-subtle { color: var(--color-subtle); }
.text-accent { color: var(--color-accent); }
.text-primary { color: var(--color-primary); }
.font-bold { font-weight: 700; }
.font-semibold { font-weight: 600; }
.mt-4 { margin-top: 4px; }
.mt-8 { margin-top: 8px; }
.mt-16 { margin-top: 16px; }
.mb-4 { margin-bottom: 4px; }
.mb-8 { margin-bottom: 8px; }
.mb-16 { margin-bottom: 16px; }
.flex { display: flex; }
.items-center { align-items: center; }
.gap-8 { gap: 8px; }
.gap-12 { gap: 12px; }
.justify-between { justify-content: space-between; }
.w-full { width: 100%; }

/* アニメーション用 */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to   { opacity: 1; transform: translateY(0); }
}
.fade-in { animation: fadeIn 0.2s ease; }
.toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: #333;
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 13px;
  opacity: 0;
  transition: opacity 0.3s, transform 0.3s;
  z-index: 9999;
  pointer-events: none;
  white-space: nowrap;
}
.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
</style>
</head>
<body>

<!-- ===== ログイン画面 ===== -->
<div id="screen-login" class="screen active">
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 3L20 7.5V16.5L12 21L4 16.5V7.5L12 3Z" stroke="#C6A75E" stroke-width="2" fill="none"/>
          <path d="M12 8L16 10.5V15.5L12 18L8 15.5V10.5L12 8Z" fill="#C6A75E"/>
        </svg>
      </div>
      <span class="login-logo-text">Crew Nest</span>
    </div>
    <p class="login-title">社内ポータルへようこそ</p>
    <p class="login-subtitle">Microsoft アカウントでサインインして<br>クエスト・ポイント管理を始めましょう。</p>
    <button class="btn-ms-login" onclick="doLogin()">
      <svg width="20" height="20" viewBox="0 0 23 23" fill="none">
        <rect x="1" y="1" width="10" height="10" fill="#f25022"/>
        <rect x="12" y="1" width="10" height="10" fill="#7fba00"/>
        <rect x="1" y="12" width="10" height="10" fill="#00a4ef"/>
        <rect x="12" y="12" width="10" height="10" fill="#ffb900"/>
      </svg>
      Microsoft アカウントでサインイン
    </button>
  </div>
</div>

<!-- ===== アプリシェル（ログイン後）===== -->
<div id="screen-app" class="screen">

  <!-- サイドバー -->
  <nav class="sidebar" id="sidebar">
    <!-- ヘッダー -->
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <div class="sidebar-brand-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M12 3L20 7.5V16.5L12 21L4 16.5V7.5L12 3Z" stroke="#042154" stroke-width="2" fill="none"/>
            <path d="M12 8L16 10.5V15.5L12 18L8 15.5V10.5L12 8Z" fill="#042154"/>
          </svg>
        </div>
        <span class="sidebar-brand-name">Crew Nest</span>
      </div>
      <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="サイドバーを折り畳む">
        <svg id="sidebarToggleIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
    </div>

    <!-- ナビゲーション -->
    <div class="sidebar-nav">
      <button class="nav-item active" id="nav-home" onclick="showPage('home', this)">
        <span class="nav-item-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
        </span>
        <span class="nav-item-label">ホーム</span>
      </button>

      <div class="nav-section-label">クエスト</div>
      <button class="nav-item" id="nav-quests" onclick="showPage('quests', this)">
        <span class="nav-item-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
        </span>
        <span class="nav-item-label">クエスト一覧</span>
      </button>
      <button class="nav-sub-item" onclick="filterCategory('all'); showPage('quests', document.getElementById('nav-quests'))">
        <span class="nav-sub-item-label">すべて</span>
      </button>
      <button class="nav-sub-item" onclick="filterCategory('cat-business'); showPage('quests', document.getElementById('nav-quests'))">
        <span class="nav-sub-item-label">業務</span>
      </button>
      <button class="nav-sub-item" onclick="filterCategory('cat-license'); showPage('quests', document.getElementById('nav-quests'))">
        <span class="nav-sub-item-label">資格</span>
      </button>
      <button class="nav-sub-item" onclick="filterCategory('cat-tenure'); showPage('quests', document.getElementById('nav-quests'))">
        <span class="nav-sub-item-label">勤続</span>
      </button>
      <button class="nav-sub-item" onclick="filterCategory('cat-health'); showPage('quests', document.getElementById('nav-quests'))">
        <span class="nav-sub-item-label">健康推進</span>
      </button>

      <div class="nav-section-label">申告管理</div>
      <button class="nav-item" id="nav-achievements" onclick="showPage('achievements', this)">
        <span class="nav-item-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
          </svg>
        </span>
        <span class="nav-item-label">申告管理</span>
        <span class="nav-badge" id="sidebar-approval-badge">1</span>
      </button>
      <button class="nav-sub-item" onclick="navToAchievements('APPROVAL')">
        <span class="nav-sub-item-label">承認待ち</span>
        <span id="sidebar-approval-sub-badge" style="margin-left:auto;background:var(--color-accent);color:var(--color-primary);font-size:10px;font-weight:700;min-width:16px;height:16px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;padding:0 4px;">1</span>
      </button>
      <button class="nav-sub-item" onclick="navToAchievements('PENDING')">
        <span class="nav-sub-item-label">申請中</span>
      </button>
      <button class="nav-sub-item" onclick="navToAchievements('RETURNED')">
        <span class="nav-sub-item-label">差し戻し</span>
        <span id="sidebar-returned-badge" style="margin-left:auto;background:var(--color-accent);color:var(--color-primary);font-size:10px;font-weight:700;min-width:16px;height:16px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;padding:0 4px;">1</span>
      </button>
      <button class="nav-sub-item" onclick="navToAchievements('APPROVED')">
        <span class="nav-sub-item-label">承認済み</span>
      </button>
      <button class="nav-sub-item" onclick="navToAchievements('REJECTED')">
        <span class="nav-sub-item-label">却下</span>
      </button>

      <div class="nav-section-label">その他</div>
      <button class="nav-item" id="nav-notifications" onclick="showPage('notifications', this)">
        <span class="nav-item-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/>
          </svg>
        </span>
        <span class="nav-item-label">通知</span>
        <span class="nav-badge" id="sidebar-notif-badge">1</span>
      </button>
    </div>

    <!-- ユーザー情報 -->
    <div class="sidebar-user">
      <div class="sidebar-avatar">山</div>
      <div class="sidebar-user-info">
        <div class="sidebar-user-name">山田 太郎</div>
        <div class="sidebar-user-email">yamada@example.com</div>
      </div>
    </div>
  </nav>

  <!-- メインコンテンツ -->
  <div class="main-content">
    <!-- モバイルヘッダー -->
    <div class="mobile-header">
      <span class="mobile-header-title" id="mobileHeaderTitle">ホーム</span>
      <div class="mobile-header-right">
        <button class="notif-btn" onclick="showPage('notifications', null)" style="color: rgba(255,255,255,0.8);">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/>
          </svg>
          <span class="notif-badge" id="mobile-notif-badge">1</span>
        </button>
        <div class="topbar-avatar" style="font-size:11px;">山</div>
      </div>
    </div>

    <!-- デスクトップトップバー -->
    <div class="topbar">
      <span class="topbar-title" id="desktopHeaderTitle">ホーム</span>
      <div class="topbar-right">
        <button class="notif-btn" onclick="showPage('notifications', null)">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/>
          </svg>
          <span class="notif-badge" id="desktop-notif-badge">1</span>
        </button>
        <div class="topbar-avatar">山</div>
      </div>
    </div>

    <!-- ページエリア -->
    <div class="page-area">

      <!-- ページ: ホーム -->
      <div class="page active" id="page-home">
        <div class="home-grid">
          <!-- ユーザーカード -->
          <div class="home-card user-card">
            <div class="user-card-avatar">山</div>
            <div class="user-card-info">
              <div class="user-card-name">山田 太郎</div>
              <div class="user-card-email">yamada@example.com</div>
            </div>
            <div class="user-card-pts">
              <div class="user-card-pts-label">獲得ポイント</div>
              <div class="user-card-pts-val">1,250 <span style="font-size:14px;font-weight:500;">pt</span></div>
            </div>
          </div>

          <!-- 統計カード -->
          <div class="home-card">
            <div class="home-card-title">活動サマリー</div>
            <div class="stat-grid">
              <div class="stat-item">
                <div class="stat-val" id="home-stat-total">17</div>
                <div class="stat-label">申告件数</div>
              </div>
              <div class="stat-item">
                <div class="stat-val" id="home-stat-approved" style="color: var(--st-approved-text)">15</div>
                <div class="stat-label">承認済み</div>
              </div>
              <div class="stat-item">
                <div class="stat-val" id="home-stat-pending" style="color: var(--st-pending-text)">2</div>
                <div class="stat-label">申請中</div>
              </div>
            </div>
          </div>

          <!-- 通知ウィジェット -->
          <div class="home-card">
            <div class="home-card-title" style="display:flex;align-items:center;justify-content:space-between;">
              <span>最近の通知</span>
              <span id="home-notif-count" style="font-size:11px; background:var(--color-accent); color:var(--color-primary); padding:2px 8px; border-radius:9999px; font-weight:700;">1 件未読</span>
            </div>
            <div class="notif-widget-list" id="notif-widget-list">
              <!-- JS で描画 -->
            </div>
          </div>
        </div>
      </div>

      <!-- ページ: クエスト一覧 -->
      <div class="page" id="page-quests">
        <div class="quest-toolbar">
          <input class="search-input" type="text" placeholder="クエスト名で検索..." id="questSearch" oninput="filterQuests()">
          <div class="filter-group" id="filterGroup">
            <button class="filter-btn active-all" id="filter-all" onclick="filterCategory('all')">すべて</button>
            <button class="filter-btn" id="filter-business" onclick="filterCategory('cat-business')">業務</button>
            <button class="filter-btn" id="filter-license"  onclick="filterCategory('cat-license')">資格</button>
            <button class="filter-btn" id="filter-tenure"   onclick="filterCategory('cat-tenure')">勤続</button>
            <button class="filter-btn" id="filter-health"   onclick="filterCategory('cat-health')">健康推進</button>
          </div>
        </div>
        <div class="quest-grid" id="questGrid">
          <!-- JS で描画 -->
        </div>
      </div>

      <!-- ページ: 申告管理 -->
      <div class="page" id="page-achievements">
        <div class="page-header">
          <h1 class="page-title">申告管理</h1>
        </div>
        <div class="tabs" id="achievementTabs">
          <button class="tab active" id="tab-approval" onclick="switchAchievementTab('approval')">承認待ち <span id="approval-tab-badge" style="margin-left:4px;"></span></button>
          <button class="tab" id="tab-mine" onclick="switchAchievementTab('mine')">自分の申告</button>
        </div>
        <div class="achievement-list" id="achievementList">
          <!-- JS で描画 -->
        </div>
      </div>

      <!-- ページ: 通知 -->
      <div class="page" id="page-notifications">
        <div class="notif-toolbar">
          <h1 class="page-title">通知</h1>
          <button class="btn btn-outline btn-sm" onclick="markAllRead()">すべて既読にする</button>
        </div>
        <div class="notif-list" id="notifList">
          <!-- JS で描画 -->
        </div>
      </div>

    </div><!-- .page-area -->
  </div><!-- .main-content -->

  <!-- BottomNav -->
  <nav class="bottom-nav">
    <div class="bottom-nav-inner">
      <button class="bottom-nav-item active" id="bnav-home" onclick="showPage('home', this)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
        <span class="bottom-nav-label">ホーム</span>
      </button>
      <button class="bottom-nav-item" id="bnav-quests" onclick="showPage('quests', this)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
        </svg>
        <span class="bottom-nav-label">クエスト</span>
      </button>
      <button class="bottom-nav-item" id="bnav-achievements" onclick="showPage('achievements', this)">
        <span class="bottom-nav-badge" id="bnav-approval-badge">1</span>
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
        </svg>
        <span class="bottom-nav-label">申告管理</span>
      </button>
      <button class="bottom-nav-item" id="bnav-notifications" onclick="showPage('notifications', this)">
        <span class="bottom-nav-badge" id="bnav-notif-badge">1</span>
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/>
        </svg>
        <span class="bottom-nav-label">通知</span>
      </button>
    </div>
  </nav>

</div><!-- #screen-app -->

<!-- ===== クエスト詳細パネル ===== -->
<div class="panel-overlay" id="questOverlay" onclick="closeQuestPanel()"></div>
<div class="slide-panel" id="questPanel">
  <div class="panel-header">
    <span class="panel-title" id="questPanelTitle">クエスト詳細</span>
    <button class="panel-close" onclick="closeQuestPanel()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  </div>
  <div class="panel-body" id="questPanelBody">
    <!-- JS で描画 -->
  </div>
</div>

<!-- ===== 申告詳細パネル ===== -->
<div class="panel-overlay" id="achievementOverlay" onclick="closeAchievementPanel()"></div>
<div class="slide-panel" id="achievementPanel">
  <div class="panel-header">
    <span class="panel-title" id="achievementPanelTitle">申告詳細</span>
    <button class="panel-close" onclick="closeAchievementPanel()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  </div>
  <div class="panel-body" id="achievementPanelBody">
    <!-- JS で描画 -->
  </div>
  <div class="panel-footer" id="achievementPanelFooter">
    <!-- JS で描画 -->
  </div>
</div>

<!-- ===== JavaScript ===== -->
<script>
/* ===== モックデータ ===== */
const CATEGORIES = [
  { id:'cat-business', name:'業務',     colorKey:'blue'  },
  { id:'cat-license',  name:'資格',     colorKey:'amber' },
  { id:'cat-tenure',   name:'勤続',     colorKey:'green' },
  { id:'cat-health',   name:'健康推進', colorKey:'rose'  },
];

const QUESTS = [
  { id:'q1', title:'技術共有 LT の実施',       catId:'cat-business', freq:'MONTHLY',   pts:100,  cap:5,    approved:3, pending:1, desc:'社内 LT（ライトニングトーク）を実施してチームの技術力向上に貢献する。月1回まで申告可能。', graceDays:5 },
  { id:'q2', title:'プロジェクト成功への貢献',  catId:'cat-business', freq:'ONCE',      pts:500,  cap:1,    approved:0, pending:0, desc:'担当プロジェクトが正式リリース・本番稼働に到達した実績を申告する。', graceDays:0 },
  { id:'q3', title:'コードレビュー実施',        catId:'cat-business', freq:'UNLIMITED', pts:50,   cap:null, approved:12,pending:0, desc:'他メンバーのプルリクエストをレビューしコメントした記録を申告する。', graceDays:0 },
  { id:'q4', title:'基本情報技術者試験合格',    catId:'cat-license',  freq:'ONCE',      pts:1000, cap:1,    approved:0, pending:1, desc:'IPA 基本情報技術者試験に合格した証明書を添付して申告する。', graceDays:30 },
  { id:'q5', title:'AWS 認定資格取得',          catId:'cat-license',  freq:'ONCE',      pts:800,  cap:1,    approved:0, pending:1, desc:'AWS 認定試験（任意のレベル）に合格した証明書を添付して申告する。', graceDays:30 },
  { id:'q6', title:'勤続 3 周年達成',           catId:'cat-tenure',   freq:'ONCE',      pts:300,  cap:1,    approved:1, pending:0, desc:'入社から満 3 年を迎えた節目を自動的に付与される。', graceDays:0 },
  { id:'q7', title:'勤続 1 周年達成',           catId:'cat-tenure',   freq:'ONCE',      pts:100,  cap:1,    approved:1, pending:0, desc:'入社から満 1 年を迎えた節目を自動的に付与される。', graceDays:0 },
  { id:'q8', title:'健康診断受診',              catId:'cat-health',   freq:'YEARLY',    pts:100,  cap:1,    approved:1, pending:0, desc:'年次健康診断の受診票を添付して申告する。年1回まで申告可能。', graceDays:30 },
];

/* ミュータブルな申告データ */
let USER_ACHIEVEMENTS = [
  { id:'a1', questId:'q8', status:'APPROVED', pts:100,  date:'2026-01-15', comment:'年次健康診断を受診しました。', approvedBy:'田中 部長', approverComment:'確認しました。お疲れ様です。', submitterName:null },
  { id:'a2', questId:'q5', status:'PENDING',  pts:800,  date:'2026-02-20', comment:'AWS Solutions Architect Professional に合格しました。添付の合格証明書をご確認ください。', approvedBy:null, approverComment:null, submitterName:null },
  { id:'a3', questId:'q4', status:'RETURNED', pts:1000, date:'2026-02-18', comment:'基本情報技術者試験に合格しました。', approvedBy:'田中 部長', approverComment:'合格証明書の添付をお願いします。スコアレポートも合わせてご提出ください。', submitterName:null },
];

let PENDING_APPROVALS = [
  { id:'a4', questId:'q3', status:'PENDING', pts:50, date:'2026-02-25', comment:'PR #142, #145, #148 のレビューを実施しました。各PRで設計・可読性の観点からコメントを行い、品質向上に貢献しました。', approvedBy:null, approverComment:null, submitterName:'佐藤 花子' },
];

let NOTIFICATIONS = [
  { id:'n1', type:'achievement_approved', title:'「健康診断受診」が承認されました',              isRead:true,  time:'3日前',      achievementId:'a1' },
  { id:'n2', type:'achievement_returned', title:'「基本情報技術者試験合格」が差し戻されました', isRead:false, time:'2分前',      achievementId:'a3' },
  { id:'n3', type:'achievement_approved', title:'「技術共有 LT の実施」が承認されました',       isRead:true,  time:'2026/01/15', achievementId:null },
];

/* ===== 状態 ===== */
let currentPage = 'home';
let sidebarCollapsed = false;
let currentAchievementTab = 'approval'; // 'approval' | 'mine'
let currentMineStatusFilter = null; // null=全件 | 'PENDING' | 'RETURNED' | 'APPROVED' | 'REJECTED'
let currentCategoryFilter = 'all';
let currentQuestSearchText = '';

/* ===== ヘルパー ===== */
function getCategory(catId) {
  return CATEGORIES.find(c => c.id === catId);
}
function getQuest(questId) {
  return QUESTS.find(q => q.id === questId);
}
function getAchievement(id) {
  return USER_ACHIEVEMENTS.find(a => a.id === id) || PENDING_APPROVALS.find(a => a.id === id);
}

function freqLabel(freq) {
  const map = { DAILY:'毎日', MONTHLY:'月次', YEARLY:'年次', ONCE:'一度のみ', UNLIMITED:'無制限' };
  return map[freq] || freq;
}

function statusLabel(status) {
  const map = { PENDING:'申請中', APPROVED:'承認済み', REJECTED:'却下', RETURNED:'差し戻し', WITHDRAWN:'取り下げ', APPROVAL:'承認待ち' };
  return map[status] || status;
}

function unreadCount() {
  return NOTIFICATIONS.filter(n => !n.isRead).length;
}

function pendingApprovalCount() {
  return PENDING_APPROVALS.length;
}

function updateBadges() {
  const uc = unreadCount();
  const ac = pendingApprovalCount();

  // 通知バッジ
  ['desktop-notif-badge','mobile-notif-badge','bnav-notif-badge','sidebar-notif-badge'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = uc > 0 ? uc : '';
      el.style.display = uc > 0 ? '' : 'none';
    }
  });
  // 承認バッジ
  ['sidebar-approval-badge','bnav-approval-badge'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = ac > 0 ? ac : '';
      el.style.display = ac > 0 ? '' : 'none';
    }
  });
  // サイドバー承認サブバッジ
  const approvalSubBadge = document.getElementById('sidebar-approval-sub-badge');
  if (approvalSubBadge) {
    approvalSubBadge.textContent = ac;
    approvalSubBadge.style.display = ac > 0 ? '' : 'none';
  }
  // 差し戻しバッジ
  const returnedCount = USER_ACHIEVEMENTS.filter(a => a.status === 'RETURNED').length;
  const returnedBadge = document.getElementById('sidebar-returned-badge');
  if (returnedBadge) {
    returnedBadge.textContent = returnedCount;
    returnedBadge.style.display = returnedCount > 0 ? '' : 'none';
  }
  // タブバッジ
  const tabBadge = document.getElementById('approval-tab-badge');
  if (tabBadge) {
    if (ac > 0) {
      tabBadge.innerHTML = `<span style="background:var(--color-accent);color:var(--color-primary);font-size:10px;font-weight:700;padding:1px 6px;border-radius:9999px;">${ac}</span>`;
    } else {
      tabBadge.innerHTML = '';
    }
  }
  // ホーム通知件数
  const hc = document.getElementById('home-notif-count');
  if (hc) {
    hc.textContent = uc > 0 ? `${uc} 件未読` : '未読なし';
    hc.style.background = uc > 0 ? 'var(--color-accent)' : 'var(--color-border)';
    hc.style.color = uc > 0 ? 'var(--color-primary)' : 'var(--color-subtle)';
  }
}

/* ===== SVG リングゲージ ===== */
function ringGauge(approved, pending, cap, colorKey) {
  const r = 14;
  const circ = 2 * Math.PI * r;
  const size = 36;
  const cx = size / 2;
  const cy = size / 2;

  // カテゴリカラー
  const colorMap = {
    blue:  '#5B7FC0',
    amber: '#B89B52',
    green: '#5A9E74',
    rose:  '#C07B8A',
  };
  const strokeColor = colorMap[colorKey] || '#5B7FC0';
  const pendingColor = '#6B7280';
  const trackColor = '#E3E6ED';

  let html = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="transform:rotate(-90deg)" class="ring-gauge">`;

  if (cap === null || cap === 0) {
    // 上限なし: 空グレーリング
    html += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${trackColor}" stroke-width="4"/>`;
    html += `</svg>`;
    return html;
  }

  const approvedRatio = Math.min(approved / cap, 1);
  const pendingRatio  = Math.min(pending / cap, 1 - approvedRatio);
  const approvedLen   = circ * approvedRatio;
  const pendingLen    = circ * pendingRatio;

  // トラック
  html += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${trackColor}" stroke-width="4"/>`;
  // 承認済み弧
  if (approvedLen > 0) {
    html += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${strokeColor}" stroke-width="4" stroke-dasharray="${approvedLen} ${circ - approvedLen}" stroke-linecap="butt"/>`;
  }
  // 申請中弧
  if (pendingLen > 0) {
    const offset = -(approvedLen);
    html += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${pendingColor}" stroke-width="4" stroke-dasharray="${pendingLen} ${circ - pendingLen}" stroke-dashoffset="${offset}" stroke-linecap="butt"/>`;
  }

  html += `</svg>`;
  return html;
}

/* ===== ログイン ===== */
function doLogin() {
  document.getElementById('screen-login').classList.remove('active');
  document.getElementById('screen-app').classList.add('active');
  initApp();
}

/* ===== 初期化 ===== */
function updateHomeStats() {
  const total    = USER_ACHIEVEMENTS.length;
  const approved = USER_ACHIEVEMENTS.filter(a => a.status === 'APPROVED').length;
  const pending  = USER_ACHIEVEMENTS.filter(a => a.status === 'PENDING').length;
  const el1 = document.getElementById('home-stat-total');
  const el2 = document.getElementById('home-stat-approved');
  const el3 = document.getElementById('home-stat-pending');
  if (el1) el1.textContent = total;
  if (el2) el2.textContent = approved;
  if (el3) el3.textContent = pending;
}

function initApp() {
  renderQuestGrid();
  renderNotifWidget();
  renderNotifList();
  renderAchievementList();
  updateBadges();
  updateHomeStats();
  showPage('home', document.getElementById('nav-home'));
}

/* ===== 画面切り替え ===== */
const PAGE_TITLES = { home:'ホーム', quests:'クエスト一覧', achievements:'申告管理', notifications:'通知' };

function showPage(page, navEl) {
  // ページ切り替え
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const target = document.getElementById('page-' + page);
  if (target) { target.classList.add('active'); target.classList.add('fade-in'); setTimeout(() => target.classList.remove('fade-in'), 200); }
  currentPage = page;

  // サイドバー nav-item のアクティブ
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (navEl && navEl.classList && navEl.classList.contains('nav-item')) {
    navEl.classList.add('active');
  } else {
    // ページ名から対応する nav-item を特定
    const navId = 'nav-' + page;
    const el = document.getElementById(navId);
    if (el) el.classList.add('active');
  }

  // BottomNav アクティブ
  document.querySelectorAll('.bottom-nav-item').forEach(n => n.classList.remove('active'));
  const bnavId = 'bnav-' + page;
  const bnavEl = document.getElementById(bnavId);
  if (bnavEl) bnavEl.classList.add('active');

  // タイトル更新
  const title = PAGE_TITLES[page] || '';
  const dtTitle = document.getElementById('desktopHeaderTitle');
  const mTitle  = document.getElementById('mobileHeaderTitle');
  if (dtTitle) dtTitle.textContent = title;
  if (mTitle)  mTitle.textContent  = title;

  // 各ページ固有の処理
  if (page === 'quests') renderQuestGrid();
  if (page === 'achievements') renderAchievementList();
  if (page === 'notifications') renderNotifList();
  if (page === 'home') { renderNotifWidget(); updateBadges(); }
}

/* ===== サイドバー折り畳み ===== */
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  sidebarCollapsed = !sidebarCollapsed;
  sidebar.classList.toggle('collapsed', sidebarCollapsed);

  const icon = document.getElementById('sidebarToggleIcon');
  if (sidebarCollapsed) {
    icon.innerHTML = '<path d="M9 18l6-6-6-6"/>';
  } else {
    icon.innerHTML = '<path d="M15 18l-6-6 6-6"/>';
  }
}

/* ===== クエストグリッド描画 ===== */
function renderQuestGrid() {
  const grid = document.getElementById('questGrid');
  if (!grid) return;

  const search = (document.getElementById('questSearch') ? document.getElementById('questSearch').value : '').toLowerCase();
  const catFilter = currentCategoryFilter;

  const filtered = QUESTS.filter(q => {
    const matchCat = catFilter === 'all' || q.catId === catFilter;
    const matchSearch = !search || q.title.toLowerCase().includes(search);
    return matchCat && matchSearch;
  });

  if (filtered.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><span class="empty-state-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span><span class="empty-state-text">クエストが見つかりません</span></div>';
    return;
  }

  grid.innerHTML = filtered.map(q => {
    const cat = getCategory(q.catId);
    const colorKey = cat ? cat.colorKey : 'blue';
    const gauge = ringGauge(q.approved, q.pending, q.cap, colorKey);

    // ユーザーの申告状況確認
    const myApproved = USER_ACHIEVEMENTS.find(a => a.questId === q.id && a.status === 'APPROVED');
    const myPending  = USER_ACHIEVEMENTS.find(a => a.questId === q.id && a.status === 'PENDING');
    const myReturned = USER_ACHIEVEMENTS.find(a => a.questId === q.id && a.status === 'RETURNED');
    let statusBadge = '';
    if (myApproved)      statusBadge = `<span class="quest-status-badge approved">承認済み</span>`;
    else if (myPending)  statusBadge = `<span class="quest-status-badge pending">申請中</span>`;
    else if (myReturned) statusBadge = `<span class="quest-status-badge" style="background:var(--st-returned-bg);color:var(--st-returned-text);border-color:var(--st-returned-border);">差し戻し</span>`;

    return `
      <div class="quest-card ${colorKey}" onclick="openQuestPanel('${q.id}')">
        <div class="quest-card-inner">
          <div class="quest-card-header">
            <div class="quest-card-badges">
              <span class="cat-badge ${colorKey}">${cat ? cat.name : ''}</span>
              <span class="freq-badge">${freqLabel(q.freq)}</span>
            </div>
            ${gauge}
          </div>
          <div class="quest-card-title">${q.title}</div>
          <div class="quest-card-footer">
            <div class="quest-pts">
              <span class="quest-pts-val">${q.pts.toLocaleString()}</span>
              <span class="quest-pts-unit">pt</span>
            </div>
            ${statusBadge}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function filterCategory(catId) {
  currentCategoryFilter = catId;
  // フィルタボタンのアクティブ状態
  const catMap = { 'all':'all', 'cat-business':'business', 'cat-license':'license', 'cat-tenure':'tenure', 'cat-health':'health' };
  const colorMap = { 'cat-business':'blue', 'cat-license':'amber', 'cat-tenure':'green', 'cat-health':'rose' };
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.className = 'filter-btn';
  });
  const suffix = catMap[catId] || 'all';
  const filterBtn = document.getElementById('filter-' + suffix);
  if (filterBtn) {
    if (catId === 'all') {
      filterBtn.classList.add('active-all');
      filterBtn.style.background = 'var(--color-primary)';
      filterBtn.style.color = '#fff';
      filterBtn.style.borderColor = 'var(--color-primary)';
    } else {
      const col = colorMap[catId];
      if (col) filterBtn.classList.add('active-' + col);
      filterBtn.style.background = '';
      filterBtn.style.color = '';
      filterBtn.style.borderColor = '';
    }
  }
  renderQuestGrid();
}

function filterQuests() {
  renderQuestGrid();
}

/* ===== クエストパネル ===== */
function openQuestPanel(questId) {
  const quest = getQuest(questId);
  if (!quest) return;
  const cat = getCategory(quest.catId);
  const colorKey = cat ? cat.colorKey : 'blue';

  const myApproved = USER_ACHIEVEMENTS.find(a => a.questId === quest.id && a.status === 'APPROVED');
  const myPending  = USER_ACHIEVEMENTS.find(a => a.questId === quest.id && a.status === 'PENDING');
  const myReturned = USER_ACHIEVEMENTS.find(a => a.questId === quest.id && a.status === 'RETURNED');
  const canApply   = !myApproved && !myPending && (quest.freq !== 'ONCE' || (!myApproved));

  let statusSection = '';
  if (myApproved) statusSection = `<div style="background:var(--st-approved-bg);border:1px solid var(--st-approved-border);border-radius:10px;padding:12px 14px;color:var(--st-approved-text);font-size:13px;font-weight:600;margin-bottom:16px;">このクエストは承認済みです</div>`;
  if (myPending)  statusSection = `<div style="background:var(--st-pending-bg);border:1px solid var(--st-pending-border);border-radius:10px;padding:12px 14px;color:var(--st-pending-text);font-size:13px;font-weight:600;margin-bottom:16px;">申請中の申告があります（審査待ち）</div>`;
  if (myReturned) statusSection = `<div style="background:var(--st-returned-bg);border:1px solid var(--st-returned-border);border-radius:10px;padding:12px 14px;color:var(--st-returned-text);font-size:13px;font-weight:600;margin-bottom:16px;">差し戻しされた申告があります。再提出が必要です。</div>`;

  const graceDaysSection = quest.graceDays > 0
    ? `<div class="quest-detail-section"><div class="quest-detail-label">申告期限</div><div class="quest-detail-value">達成日から ${quest.graceDays} 日以内</div></div>`
    : '';

  const formSection = canApply && !myApproved && !myPending ? `
    <hr style="border:none;border-top:1px solid var(--color-border);margin:8px 0 20px;">
    <div style="font-size:14px;font-weight:700;color:var(--color-primary);margin-bottom:16px;">申告する</div>
    <div class="form-group">
      <label class="form-label">コメント</label>
      <textarea class="form-textarea" placeholder="申告内容のコメントを入力してください..." rows="3"></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">添付ファイル（任意）</label>
      <div class="upload-area">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display:block;margin:0 auto 8px;opacity:0.5;">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        ファイルをドラッグ＆ドロップ、またはクリックして選択
      </div>
    </div>
    <button class="btn btn-accent btn-block" onclick="submitQuest('${quest.id}')">申告を提出する</button>
  ` : '';

  document.getElementById('questPanelTitle').textContent = quest.title;
  document.getElementById('questPanelBody').innerHTML = `
    ${statusSection}
    <div class="quest-detail-section">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
        <span class="cat-badge ${colorKey}">${cat ? cat.name : ''}</span>
        <span class="freq-badge">${freqLabel(quest.freq)}</span>
      </div>
      <div class="detail-pts"><span class="detail-pts-val">${quest.pts.toLocaleString()}</span><span class="detail-pts-unit">pt</span></div>
    </div>
    <div class="quest-detail-section">
      <div class="quest-detail-label">クエスト説明</div>
      <div class="quest-detail-value">${quest.desc}</div>
    </div>
    ${graceDaysSection}
    <div class="quest-detail-section">
      <div class="quest-detail-label">申告状況（全ユーザー）</div>
      <div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--color-subtle);">
        ${ringGauge(quest.approved, quest.pending, quest.cap, colorKey)}
        <span>${quest.cap ? `${quest.approved} / ${quest.cap} 承認済み` : `${quest.approved} 件承認済み（上限なし）`}${quest.pending > 0 ? ` · ${quest.pending} 件申請中` : ''}</span>
      </div>
    </div>
    ${formSection}
  `;

  document.getElementById('questOverlay').classList.add('open');
  document.getElementById('questPanel').classList.add('open');
}

function closeQuestPanel() {
  document.getElementById('questOverlay').classList.remove('open');
  document.getElementById('questPanel').classList.remove('open');
}

function submitQuest(questId) {
  const quest = getQuest(questId);
  if (!quest) return;
  // モックとしてステータスを申請中にして追加
  USER_ACHIEVEMENTS.push({
    id: 'a_new_' + Date.now(),
    questId,
    status: 'PENDING',
    pts: quest.pts,
    date: '2026-02-27',
    comment: '（デモ申告）',
    approvedBy: null,
    approverComment: null,
    submitterName: null,
  });
  closeQuestPanel();
  renderQuestGrid();
  renderAchievementList();
}

/* ===== 申告管理 ===== */
function switchAchievementTab(tab) {
  currentAchievementTab = tab;
  document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
  const el = document.getElementById('tab-' + tab);
  if (el) el.classList.add('active');
  renderAchievementList();
}

function navToAchievements(status) {
  showPage('achievements', document.getElementById('nav-achievements'));
  if (status === 'APPROVAL') {
    currentMineStatusFilter = null;
    switchAchievementTab('approval');
  } else {
    currentMineStatusFilter = status;
    switchAchievementTab('mine');
  }
}

function renderAchievementList() {
  const list = document.getElementById('achievementList');
  if (!list) return;

  let data;
  if (currentAchievementTab === 'approval') {
    data = PENDING_APPROVALS;
  } else if (currentMineStatusFilter) {
    data = USER_ACHIEVEMENTS.filter(a => a.status === currentMineStatusFilter);
  } else {
    data = USER_ACHIEVEMENTS;
  }

  if (data.length === 0) {
    list.innerHTML = `<div class="empty-state"><span class="empty-state-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg></span><span class="empty-state-text">申告はありません</span></div>`;
    if (currentAchievementTab === 'approval') {
      const desc = document.createElement('p');
      desc.style.cssText = 'font-size:12px; color:var(--color-subtle); margin-bottom:12px; padding:8px 12px; background:var(--color-background); border-radius:8px;';
      desc.textContent = 'あなたが承認者として指定されている申告が表示されます';
      list.prepend(desc);
    }
    return;
  }

  list.innerHTML = data.map(a => {
    const quest = getQuest(a.questId);
    const cat = quest ? getCategory(quest.catId) : null;
    const colorKey = cat ? cat.colorKey : 'blue';
    const submitterLabel = a.submitterName ? `<span>${a.submitterName}</span>` : '';
    return `
      <div class="achievement-card" id="acard-${a.id}" onclick="openAchievementPanel('${a.id}')">
        <div class="achievement-card-header">
          <span class="achievement-card-title">${quest ? quest.title : '（不明なクエスト）'}</span>
          <span class="status-badge status-${a.status}">
            <span class="status-dot status-dot-${a.status}"></span>
            ${statusLabel(a.status)}
          </span>
        </div>
        <div class="achievement-card-meta">
          ${cat ? `<span class="cat-badge ${colorKey}" style="font-size:10px;">${cat.name}</span>` : ''}
          <span>${a.pts.toLocaleString()} pt</span>
          <span>${a.date}</span>
          ${submitterLabel}
        </div>
      </div>
    `;
  }).join('');

  if (currentAchievementTab === 'approval') {
    const desc = document.createElement('p');
    desc.style.cssText = 'font-size:12px; color:var(--color-subtle); margin-bottom:12px; padding:8px 12px; background:var(--color-background); border-radius:8px;';
    desc.textContent = 'あなたが承認者として指定されている申告が表示されます';
    list.prepend(desc);
  }
}

function openAchievementPanel(achievementId) {
  const a = getAchievement(achievementId);
  if (!a) return;
  const quest = getQuest(a.questId);
  const cat = quest ? getCategory(quest.catId) : null;
  const colorKey = cat ? cat.colorKey : 'blue';
  const isApproval = PENDING_APPROVALS.some(x => x.id === achievementId);

  document.getElementById('achievementPanelTitle').textContent = quest ? quest.title : '申告詳細';

  document.getElementById('achievementPanelBody').innerHTML = `
    <div class="detail-section">
      <div class="detail-label">クエスト</div>
      <div class="detail-text" style="font-weight:600;">${quest ? quest.title : '—'}</div>
      <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;">
        ${cat ? `<span class="cat-badge ${colorKey}">${cat.name}</span>` : ''}
        ${quest ? `<span class="freq-badge">${freqLabel(quest.freq)}</span>` : ''}
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-label">ステータス</div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <span class="status-badge status-${a.status}" id="detail-status-badge-${a.id}">
          <span class="status-dot status-dot-${a.status}"></span>
          ${statusLabel(a.status)}
        </span>
        <span style="font-size:12px;color:var(--color-subtle);">申告日: ${a.date}</span>
      </div>
    </div>
    ${a.submitterName ? `<div class="detail-section"><div class="detail-label">申告者</div><div class="detail-text">${a.submitterName}</div></div>` : ''}
    <div class="detail-section">
      <div class="detail-label">獲得ポイント</div>
      <div style="font-size:24px;font-weight:700;color:var(--color-primary);">${a.pts.toLocaleString()} <span style="font-size:13px;color:var(--color-subtle);font-weight:400;">pt</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-label">申告コメント</div>
      <div class="detail-comment-box">${a.comment}</div>
    </div>
    ${a.approvedBy ? `
    <div class="detail-section">
      <div class="detail-label">審査者コメント <span style="font-size:11px;font-weight:400;color:var(--color-subtle);">by ${a.approvedBy}</span></div>
      <div class="detail-comment-box approver">${a.approverComment || '—'}</div>
    </div>` : ''}
  `;

  // フッターのアクションボタン
  let footerHtml = '';
  if (isApproval && a.status === 'PENDING') {
    footerHtml = `
      <div class="approval-actions">
        <button class="btn btn-accent" style="flex:1;" onclick="approveAchievement('${a.id}')">承認する</button>
        <button class="btn btn-warn"   style="flex:1;" onclick="returnAchievement('${a.id}')">差し戻す</button>
        <button class="btn btn-danger btn-sm" onclick="rejectAchievement('${a.id}')">却下</button>
      </div>
    `;
  } else if (!isApproval) {
    if (a.status === 'PENDING') {
      footerHtml = `<button class="btn btn-outline btn-block" onclick="withdrawAchievement('${a.id}')">取り下げる</button>`;
    } else if (a.status === 'RETURNED') {
      footerHtml = `
        <div style="margin-bottom:8px;font-size:13px;color:var(--color-subtle);">差し戻しされています。コメントを修正して再提出してください。</div>
        <button class="btn btn-accent btn-block" onclick="mockResubmit('${a.id}')">再提出する</button>
      `;
    }
  }
  document.getElementById('achievementPanelFooter').innerHTML = footerHtml;

  document.getElementById('achievementOverlay').classList.add('open');
  document.getElementById('achievementPanel').classList.add('open');
}

function closeAchievementPanel() {
  document.getElementById('achievementOverlay').classList.remove('open');
  document.getElementById('achievementPanel').classList.remove('open');
  // カード選択状態を解除
  document.querySelectorAll('.achievement-card.selected').forEach(c => c.classList.remove('selected'));
}

/* ===== 承認アクション ===== */
function approveAchievement(id) {
  const idx = PENDING_APPROVALS.findIndex(a => a.id === id);
  if (idx === -1) return;
  PENDING_APPROVALS.splice(idx, 1);
  closeAchievementPanel();
  renderAchievementList();
  updateBadges();
}

function returnAchievement(id) {
  const idx = PENDING_APPROVALS.findIndex(a => a.id === id);
  if (idx === -1) return;
  PENDING_APPROVALS.splice(idx, 1);
  closeAchievementPanel();
  renderAchievementList();
  updateBadges();
}

function rejectAchievement(id) {
  const idx = PENDING_APPROVALS.findIndex(a => a.id === id);
  if (idx === -1) return;
  PENDING_APPROVALS.splice(idx, 1);
  closeAchievementPanel();
  renderAchievementList();
  updateBadges();
}

function mockResubmit(id) {
  // モックでは「再提出」操作を差し戻し → 申請中に変える
  const a = USER_ACHIEVEMENTS.find(x => x.id === id);
  if (!a) return;
  a.status = 'PENDING';
  closeAchievementPanel();
  showToast('再提出しました。申請中に戻りました。');
  renderAchievementList();
  updateBadges();
}

function withdrawAchievement(id) {
  if (!confirm('「取り下げ」しますか？この操作は取り消せません。')) return;
  const a = USER_ACHIEVEMENTS.find(x => x.id === id);
  if (!a) return;
  a.status = 'WITHDRAWN';
  // パネル上のステータスバッジを更新
  const badge = document.getElementById('detail-status-badge-' + id);
  if (badge) {
    badge.className = 'status-badge status-WITHDRAWN';
    badge.innerHTML = `<span class="status-dot status-dot-WITHDRAWN"></span>取り下げ`;
  }
  // フッターをクリア
  document.getElementById('achievementPanelFooter').innerHTML = '';
  // カード再描画
  renderAchievementList();
  renderQuestGrid();
  closeAchievementPanel();
}

/* ===== 通知 ===== */
function renderNotifList() {
  const list = document.getElementById('notifList');
  if (!list) return;

  list.innerHTML = NOTIFICATIONS.map(n => {
    const typeClass = n.type === 'achievement_approved' ? 'approved' : (n.type === 'achievement_returned' ? 'returned' : 'pending');
    const iconSvg = n.type === 'achievement_approved'
      ? `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--st-approved-text)" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>`
      : n.type === 'achievement_returned'
      ? `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--st-returned-text)" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.5"/></svg>`
      : `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--st-pending-text)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`;

    return `
      <div class="notif-item ${n.isRead ? '' : 'unread'}" id="notif-${n.id}" onclick="handleNotifClick('${n.id}')">
        <div class="notif-icon ${typeClass}">${iconSvg}</div>
        <div class="notif-content">
          <div class="notif-title">${n.title}</div>
          <div class="notif-time">${n.time}</div>
        </div>
        ${!n.isRead ? '<div class="notif-unread-dot"></div>' : ''}
      </div>
    `;
  }).join('');
}

function renderNotifWidget() {
  const list = document.getElementById('notif-widget-list');
  if (!list) return;

  const recent = NOTIFICATIONS.slice(0, 3);
  if (recent.length === 0) {
    list.innerHTML = '<div style="font-size:13px;color:var(--color-subtle-light);padding:12px 0;">通知はありません</div>';
    return;
  }

  list.innerHTML = recent.map(n => `
    <button class="notif-widget-item ${!n.isRead ? 'unread' : ''}" onclick="handleNotifClick('${n.id}')">
      <span class="notif-dot ${n.isRead ? 'read' : ''}"></span>
      <span>
        <div class="notif-widget-text">${n.title}</div>
        <div class="notif-widget-time">${n.time}</div>
      </span>
    </button>
  `).join('');
}

function handleNotifClick(notifId) {
  // 既読に更新
  const notif = NOTIFICATIONS.find(n => n.id === notifId);
  if (!notif) return;
  notif.isRead = true;

  // 再描画
  renderNotifList();
  renderNotifWidget();
  updateBadges();

  // 差し戻し通知 (n2 -> a3) のデモストーリー導線
  if (notif.achievementId) {
    const aId = notif.achievementId;
    const target = USER_ACHIEVEMENTS.find(a => a.id === aId);
    if (target) {
      // 申告管理画面へ遷移して、自分の申告タブで当該申告の詳細パネルを開く
      switchAchievementTab('mine');
      showPage('achievements', document.getElementById('nav-achievements'));
      setTimeout(() => {
        openAchievementPanel(aId);
        // 対象カードをハイライト
        const card = document.getElementById('acard-' + aId);
        if (card) { card.classList.add('selected'); card.scrollIntoView({ behavior:'smooth', block:'center' }); }
      }, 100);
    }
  }
}

function markAllRead() {
  NOTIFICATIONS.forEach(n => { n.isRead = true; });
  renderNotifList();
  renderNotifWidget();
  updateBadges();
}

/* ===== トースト ===== */
function showToast(msg, durationMs = 2500) {
  const el = document.getElementById('toast');
  if (!el) return;
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), durationMs);
}

/* ===== 初期状態でフィルタボタンのスタイルをセット ===== */
document.addEventListener('DOMContentLoaded', () => {
  const allBtn = document.getElementById('filter-all');
  if (allBtn) {
    allBtn.style.background = 'var(--color-primary)';
    allBtn.style.color = '#fff';
    allBtn.style.borderColor = 'var(--color-primary)';
  }
  updateBadges();
});
</script>
<div id="toast" class="toast"></div>
</body>
</html>
